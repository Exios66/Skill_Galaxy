<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Comprehensive Skill Galaxy</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    /* General Styling */
    body, html {
      height: 100%;
      width: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      color: #333;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    h1, h2, h3 {
      margin: 0;
      padding: 0;
    }

    /* Plot Container */
    #plot {
      flex: 1 1 auto;
      width: 100%;
      height: 100%;
    }

    /* Loading Indicator with Spinner */
    .loading-indicator {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 1000;
      display: none;
      text-align: center;
    }

    .loading-indicator::before {
      content: '';
      display: inline-block;
      width: 30px;
      height: 30px;
      border: 4px solid #ccc;
      border-top-color: #0066cc;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
      vertical-align: middle;
    }

    .loading-indicator::after {
      content: 'Updating visualization...';
      display: inline-block;
      vertical-align: middle;
      font-size: 1rem;
      color: #333;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Error Message */
    .error-message {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #ff5555;
      color: white;
      padding: 10px 20px;
      border-radius: 4px;
      display: none;
      z-index: 1000;
    }

    /* Control Panel */
    .control-panel {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255,255,255,0.95);
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      max-width: 300px;
      z-index: 10;
      overflow-y: auto;
    }

    .control-panel h2 {
      font-size: 1.2em;
      margin-bottom: 10px;
    }

    .control-panel .control-group {
      margin-bottom: 15px;
    }

    .control-panel label {
      display: block;
      margin-top: 8px;
      font-weight: bold;
      font-size: 1em;
    }

    .control-panel select,
    .control-panel input {
      width: 100%;
      margin: 5px 0;
      padding: 8px;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: white;
    }

    .control-panel button {
      margin-top: 10px;
      width: 100%;
      padding: 10px;
      background: #0066cc;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 1em;
      cursor: pointer;
      transition: background 0.2s ease-in-out;
    }

    .control-panel button:hover {
      background: #004999;
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
      .control-panel {
        top: auto;
        bottom: 10px;
        right: 50%;
        transform: translateX(50%);
        max-width: 90%;
      }

      #plot {
        height: calc(100vh - 120px);
      }

      .control-panel h2 {
        font-size: 1rem;
      }

      .control-panel label {
        font-size: 0.9rem;
      }

      .control-panel select,
      .control-panel input,
      .control-panel button {
        font-size: 0.9rem;
        padding: 6px;
      }
    }

    /* Touch-Friendly Controls */
    .control-panel button,
    .control-panel select,
    .control-panel input {
      touch-action: manipulation;
    }

    .control-panel button {
      padding: 10px;
    }

    /* Pre-render Placeholder */
    #pre-render {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #f7f7f7;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
      font-size: 1.2rem;
      color: #666;
    }

    /* Skill Details Panel */
    .skill-details-panel {
      position: absolute;
      left: 10px;
      top: 10px;
      width: 300px;
      background: rgba(255, 255, 255, 0.98);
      border-radius: 8px;
      box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
      transform: translateX(-120%);
      transition: transform 0.3s ease-in-out;
      z-index: 100;
    }

    .skill-details-panel.active {
      transform: translateX(0);
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border-bottom: 1px solid #eee;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 1.5em;
      cursor: pointer;
      color: #666;
    }

    .panel-content {
      padding: 15px;
    }

    .skill-metrics {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }

    .metric-card {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 6px;
      text-align: center;
    }

    .related-skills {
      margin-bottom: 15px;
    }

    .skill-tag {
      display: inline-block;
      padding: 4px 8px;
      margin: 2px;
      background: #e9ecef;
      border-radius: 4px;
      font-size: 0.9em;
    }

    /* Connection Canvas */
    #connectionCanvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 5;
    }

    /* Skill Node Enhancements */
    .skill-node {
      position: relative;
    }

    .skill-node::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 100%;
      height: 100%;
      transform: translate(-50%, -50%);
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 70%);
      pointer-events: none;
    }

    /* Skill Progress Indicator */
    .skill-progression {
      margin-top: 15px;
    }

    .progress-bar {
      height: 8px;
      background: #eee;
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #4CAF50 0%, #8BC34A 100%);
      transition: width 0.3s ease;
    }

    /* Dark Mode Styles */
    :root {
      --bg-color: #f7f7f7;
      --text-color: #333;
      --panel-bg: rgba(255, 255, 255, 0.95);
      --panel-shadow: rgba(0, 0, 0, 0.1);
      --accent-color: #0066cc;
      --hover-color: #004999;
      --border-color: #ccc;
      --card-bg: #f8f9fa;
    }

    [data-theme="dark"] {
      --bg-color: #1a1a1a;
      --text-color: #e0e0e0;
      --panel-bg: rgba(40, 40, 40, 0.95);
      --panel-shadow: rgba(0, 0, 0, 0.3);
      --accent-color: #4d94ff;
      --hover-color: #3385ff;
      --border-color: #404040;
      --card-bg: #2d2d2d;
    }

    body {
      background: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* Theme Toggle Button */
    .theme-toggle {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1000;
    }

    .theme-toggle button {
      background: var(--panel-bg);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px var(--panel-shadow);
      transition: all 0.3s ease;
    }

    .theme-toggle button:hover {
      transform: scale(1.1);
    }

    .theme-toggle svg {
      width: 24px;
      height: 24px;
      fill: var(--text-color);
    }

    .sun-icon {
      display: none;
    }

    [data-theme="dark"] .sun-icon {
      display: block;
    }

    [data-theme="dark"] .moon-icon {
      display: none;
    }

    /* Enhanced Control Panel */
    .control-panel {
      background: var(--panel-bg);
      box-shadow: 0 4px 20px var(--panel-shadow);
      transition: all 0.3s ease;
    }

    .control-panel select,
    .control-panel input[type="text"] {
      background: var(--bg-color);
      color: var(--text-color);
      border: 1px solid var(--border-color);
    }

    .control-panel button {
      background: var(--accent-color);
    }

    .control-panel button:hover {
      background: var(--hover-color);
    }

    /* Enhanced Skill Details Panel */
    .skill-details-panel {
      background: var(--panel-bg);
      box-shadow: 0 4px 20px var(--panel-shadow);
    }

    .metric-card {
      background: var(--card-bg);
      color: var(--text-color);
      transition: transform 0.2s ease;
    }

    .metric-card:hover {
      transform: translateY(-2px);
    }

    .skill-tag {
      background: var(--card-bg);
      color: var(--text-color);
      transition: all 0.2s ease;
    }

    .skill-tag:hover {
      background: var(--accent-color);
      color: white;
    }

    /* Enhanced Progress Bar */
    .progress-bar {
      background: var(--card-bg);
    }

    .progress-fill {
      background: linear-gradient(90deg, var(--accent-color) 0%, var(--hover-color) 100%);
    }
  </style>
</head>
<body>

  <!-- Pre-render Placeholder -->
  <div id="pre-render">Loading Skill Galaxy...</div>

  <!-- Plot Container -->
  <div id="plot"></div>

  <!-- Loading Indicator -->
  <div class="loading-indicator"></div>

  <!-- Error Message -->
  <div class="error-message"></div>

  <!-- Control Panel -->
  <div class="control-panel">
    <h2>Skill Galaxy Controls</h2>
    
    <div class="control-group">
      <label for="groupFilter">Filter by Group:</label>
      <select id="groupFilter">
        <option value="All" selected>All Groups</option>
      </select>
    </div>
    
    <div class="control-group">
      <label for="searchSkill">Filter by Skill:</label>
      <input type="text" id="searchSkill" placeholder="Type skill name..."/>
    </div>
    
    <div class="control-group">
      <label for="colorBy">Color Options:</label>
      <select id="colorBy">
        <option value="Group" selected>Color by Group</option>
        <option value="Size">Color by Size</option>
      </select>
    </div>
    
    <div class="control-group">
      <label for="viewPresets">View Presets:</label>
      <select id="viewPresets">
        <option value="default">Default View</option>
        <option value="top">Top View</option>
        <option value="side">Side View</option>
        <option value="cluster">Cluster View</option>
      </select>
    </div>
    
    <div class="control-group">
      <label for="visualizationMode">Visualization Mode:</label>
      <select id="visualizationMode">
        <option value="galaxy">3D Skill Galaxy</option>
        <option value="network">Network Graph</option>
        <option value="treemap">Skill TreeMap</option>
        <option value="radar">Radar Chart</option>
        <option value="sunburst">Sunburst Hierarchy</option>
        <option value="timeline">Skill Timeline</option>
        <option value="matrix">Correlation Matrix</option>
      </select>
    </div>
    
    <div class="control-group">
      <label for="animationSpeed">Animation Speed:</label>
      <input type="range" id="animationSpeed" min="100" max="1000" value="500" step="100">
    </div>
    
    <div class="control-group">
      <label for="labelSize">Label Size:</label>
      <input type="range" id="labelSize" min="8" max="16" value="12" step="1">
    </div>
    
    <button id="resetBtn">Reset Filters</button>
  </div>
  
  <!-- Add after the control panel div -->
  <div class="skill-details-panel">
    <div class="panel-header">
      <h3>Skill Details</h3>
      <button class="close-btn">&times;</button>
    </div>
    <div class="panel-content">
      <div class="skill-metrics"></div>
      <div class="related-skills"></div>
      <div class="skill-progression"></div>
    </div>
  </div>

  <!-- Add connection canvas for skill relationships -->
  <canvas id="connectionCanvas"></canvas>
  
  <!-- Add after the control panel div -->
  <div class="theme-toggle">
    <button id="themeToggle" aria-label="Toggle dark mode">
      <svg class="sun-icon" viewBox="0 0 24 24">
        <path d="M12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.65 0-3 1.35-3 3s1.35 3 3 3 3-1.35 3-3-1.35-3-3-3zm0-2c.28 0 .5-.22.5-.5v-3c0-.28-.22-.5-.5-.5s-.5.22-.5.5v3c0 .28.22.5.5.5zm0 14c-.28 0-.5.22-.5.5v3c0 .28.22.5.5.5s.5-.22.5-.5v-3c0-.28-.22-.5-.5-.5zm7-7c0-.28-.22-.5-.5-.5h-3c-.28 0-.5.22-.5.5s.22.5.5.5h3c.28 0 .5-.22.5-.5zm-11 0c0-.28.22-.5.5-.5h3c.28 0 .5.22.5.5s-.22.5-.5.5h-3c-.28 0-.5-.22-.5-.5z"/>
      </svg>
      <svg class="moon-icon" viewBox="0 0 24 24">
        <path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-3.03 0-5.5-2.47-5.5-5.5 0-1.82.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/>
      </svg>
    </button>
  </div>

  <script>
    // ---------------------
    // 1. Utility Functions
    // ---------------------
    
    function showLoading() {
      document.querySelector('.loading-indicator').style.display = 'block';
    }
    
    function hideLoading() {
      document.querySelector('.loading-indicator').style.display = 'none';
    }
    
    function showError(message) {
      const errorDiv = document.querySelector('.error-message');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 3000);
    }
    
    function validateSkillData(skill) {
      try {
        if (!skill || typeof skill !== 'object') return false;
        return typeof skill.X === 'number' && 
               typeof skill.Y === 'number' && 
               typeof skill.Size === 'number' &&
               typeof skill.Group === 'string' &&
               typeof skill.Label === 'string' &&
               !isNaN(skill.X) && !isNaN(skill.Y) && !isNaN(skill.Size);
      } catch (error) {
        console.error('Validation error:', error);
        return false;
      }
    }
    
    // ---------------------
    // 2. Data Management
    // ---------------------
    
    const allSkills = [
      // Your existing skills data...
      {
        Skill: "Negotiation", Group: "Soft Skills", Label: "Negotiation",
        X: 0.6, Y: 0.55, Size: 8, ColorCode: "Soft Skills"
      },
      // (Additional skill objects)
      {
        Skill: "Python (Programming Language)", Group: "Programming", Label: "Python",
        X: 0.9, Y: 0.7, Size: 15, ColorCode: "Programming"
      }
    ].filter(validateSkillData);
    
    if (allSkills.length === 0) {
      showError('No valid skills data found');
    }
    
    // --------------------------------------
    // 3. Initialize Filters & UI Elements
    // --------------------------------------
    
    const groupFilterSelect = document.getElementById('groupFilter');
    const colorBySelect = document.getElementById('colorBy');
    const searchSkillInput = document.getElementById('searchSkill');
    const resetBtn = document.getElementById('resetBtn');
    const viewPresetsSelect = document.getElementById('viewPresets');
    const animationSpeedInput = document.getElementById('animationSpeed');
    const labelSizeInput = document.getElementById('labelSize');
    
    // Populate group filter dropdown
    const uniqueGroups = [...new Set(allSkills.map(d => d.Group))];
    uniqueGroups.forEach(group => {
      const option = document.createElement('option');
      option.value = group;
      option.textContent = group;
      groupFilterSelect.appendChild(option);
    });
    
    // Compute Z-value for 3D visualization
    function computeZ(x, y) {
      const base = (Math.pow(x, 1.2) + Math.pow(y, 1.2)) / 2;
      const variation = Math.sin(x * Math.PI) * Math.cos(y * Math.PI) * 0.1;
      return Math.max(0, Math.min(1, base + variation));
    }
    
    // ---------------------
    // 4. Color Mappings & Utility Functions
    // ---------------------
    function colorByGroup(group) {
      const groupColors = {
        "Soft Skills": "#FF6B6B",     // Warm red
        "Data Science": "#4ECDC4",    // Teal
        "Research": "#45B7D1",        // Sky blue
        "Neuroscience": "#96CEB4",    // Sage green
        "Engineering": "#FFBE0B",     // Golden yellow
        "Education": "#4CAF50",       // Green
        "AI": "#9B5DE5",               // Purple
        "Programming": "#00BCD4",     // Cyan
        "Psychology": "#FF85A1"        // Pink
      };
      return groupColors[group] || "#78909C"; // Default color
    }
    
    // ---------------------
    // 5. Plotly Configuration
    // ---------------------
    
    const layout = {
      title: {
        text: 'Comprehensive Skill Galaxy',
        font: {
          family: 'Arial, sans-serif',
          size: 24,
          color: '#333'
        },
        y: 0.95
      },
      scene: {
        xaxis: {
          title: {
            text: 'Proficiency',
            font: { size: 14 }
          },
          gridcolor: '#e0e0e0',
          zerolinecolor: '#999',
          showbackground: true,
          backgroundcolor: 'rgba(247, 247, 247, 0.95)',
          showspikes: true,
          spikesides: true,
          spikethickness: 1,
          spikecolor: '#999',
          gridwidth: 1,
          nticks: 10,
          range: [0, 1]
        },
        yaxis: {
          title: {
            text: 'Importance',
            font: { size: 14 }
          },
          gridcolor: '#e0e0e0',
          zerolinecolor: '#999',
          showbackground: true,
          backgroundcolor: 'rgba(247, 247, 247, 0.95)',
          showspikes: true,
          spikesides: true,
          spikethickness: 1,
          spikecolor: '#999',
          gridwidth: 1,
          nticks: 10,
          range: [0, 1]
        },
        zaxis: {
          title: {
            text: 'Depth of Expertise',
            font: { size: 14 }
          },
          gridcolor: '#e0e0e0',
          zerolinecolor: '#999',
          showbackground: true,
          backgroundcolor: 'rgba(247, 247, 247, 0.95)',
          showspikes: true,
          spikesides: true,
          spikethickness: 1,
          spikecolor: '#999',
          gridwidth: 1,
          nticks: 10,
          range: [0, 1]
        },
        camera: {
          eye: { x: 1.8, y: 1.8, z: 1.8 },
          up: { x: 0, y: 0, z: 1 },
          center: { x: 0, y: 0, z: 0 },
          projection: {
            type: 'perspective',
            distance: 2.5,
            distanceratio: 0.3
          }
        },
        aspectratio: { x: 1.2, y: 1.2, z: 1 },
        dragmode: 'orbit',
        hovermode: 'closest',
        annotations: [],
        lighting: {
          ambient: 0.6,
          diffuse: 0.8,
          specular: 0.2,
          roughness: 0.5,
          fresnel: 0.8
        }
      },
      margin: { l: 0, r: 0, t: 50, b: 0 },
      showlegend: true,
      legend: {
        x: 0,
        y: 1,
        bgcolor: 'rgba(255, 255, 255, 0.9)',
        bordercolor: '#e0e0e0',
        borderwidth: 1,
        font: { size: 12 }
      },
      paper_bgcolor: '#f7f7f7',
      plot_bgcolor: '#f7f7f7'
    };
    
    const config = {
      responsive: true,
      scrollZoom: true,
      displayModeBar: true,
      modeBarButtonsToAdd: [
        'hoverclosest',
        'hovercompare',
        'togglespikelines',
        {
          name: 'Reset View',
          icon: Plotly.Icons.home,
          click: function(gd) {
            Plotly.relayout(gd, {
              'scene.camera': layout.scene.camera
            });
          }
        }
      ],
      modeBarButtonsToRemove: ['toImage'],
      displaylogo: false
    };
    
    // Master arrays for filtered data & plotly trace
    let filteredData = [];
    let currentTrace = null;
    
    // ---------------------
    // 6. Plot Rendering Function
    // ---------------------
    
    // Build an enhanced trace from a dataset
    function makeTrace(dataArray) {
      const groups = [...new Set(dataArray.map(d => d.Group))];
      return groups.map(group => {
        const groupData = dataArray.filter(d => d.Group === group);
        return {
          type: 'scatter3d',
          mode: 'markers+text',
          name: group,
          x: groupData.map(d => d.X),
          y: groupData.map(d => d.Y),
          z: groupData.map(d => computeZ(d.X, d.Y)),
          text: groupData.map(d => d.Label),
          textposition: 'top center',
          textfont: {
            family: 'Arial, sans-serif',
            size: parseInt(labelSizeInput.value),
            color: 'rgba(0, 0, 0, 0.7)'
          },
          marker: {
            size: groupData.map(d => d.Size * 2),
            color: groupData.map(d => colorByGroup(d.ColorCode)),
            opacity: 0.85,
            line: {
              color: 'rgba(255, 255, 255, 0.8)',
              width: 1.5
            },
            symbol: 'circle',
            sizemode: 'diameter',
            sizeref: 0.1,
            sizemin: 4,
            colorscale: 'Viridis',
            showscale: true,
            reversescale: false,
            gradient: {
              type: 'radial',
              color: 'white'
            }
          },
          hovertemplate:
            '<div style="background: rgba(255,255,255,0.95); padding: 10px; border-radius: 5px;">' +
            '<b style="font-size: 14px; color: #333;">%{text}</b><br>' +
            '<span style="color: #666;">Group:</span> ' + group + '<br>' +
            '<span style="color: #666;">Proficiency:</span> %{x:.2f}<br>' +
            '<span style="color: #666;">Importance:</span> %{y:.2f}<br>' +
            '<span style="color: #666;">Expertise:</span> %{z:.2f}<br>' +
            '<span style="color: #666;">Impact:</span> %{marker.size:.1f}' +
            '</div><extra></extra>',
          hoverlabel: {
            bgcolor: 'rgba(255, 255, 255, 0.95)',
            bordercolor: '#333',
            font: { 
              family: 'Arial, sans-serif',
              size: 13
            },
            align: 'left'
          }
        };
      });
    }
    
    // ---------------------
    // 7. Plot Update Function
    // ---------------------
    
    function updatePlot() {
      const preRender = document.getElementById('pre-render');
      preRender.style.display = 'flex';
      showLoading();

      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      const traces = makeTrace(filteredData);
      
      // Update layout colors based on theme
      const updatedLayout = {
        ...layout,
        paper_bgcolor: isDark ? '#1a1a1a' : '#f7f7f7',
        plot_bgcolor: isDark ? '#1a1a1a' : '#f7f7f7',
        font: {
          color: isDark ? '#e0e0e0' : '#333'
        }
      };

      Plotly.react('plot', traces, updatedLayout, config)
        .then(() => {
          preRender.style.display = 'none';
          hideLoading();
          const duration = window.animationDuration || 500;
          Plotly.animate('plot', {
            data: traces,
            layout: updatedLayout
          }, {
            transition: {
              duration: duration,
              easing: 'cubic-in-out'
            },
            frame: {
              duration: duration
            }
          });
        })
        .catch(error => {
          console.error('Plot update error:', error);
          showError('Error updating visualization');
          hideLoading();
          preRender.style.display = 'none';
        });
    }
    
    // ---------------------
    // 8. Coloring Logic (Group vs Size)
    // ---------------------
    function applyColorBy() {
      if (!currentTrace) return;
    
      if (colorBySelect.value === "Size") {
        // Color by size (using a hue gradient)
        const newColors = filteredData.map(skill => {
          const hue = Math.floor((skill.Size / 15) * 240); 
          return `hsl(${hue}, 70%, 50%)`;
        });
        Plotly.restyle('plot', { 'marker.color': [newColors] });
      } else {
        // Color by group
        const newColors = filteredData.map(skill => colorByGroup(skill.ColorCode));
        Plotly.restyle('plot', { 'marker.color': [newColors] });
      }
    }
    
    // ---------------------
    // 9. Event Handlers & Reset
    // ---------------------
    colorBySelect.addEventListener('change', applyColorBy);
    groupFilterSelect.addEventListener('change', updatePlot);
    searchSkillInput.addEventListener('keyup', updatePlot);
    
    resetBtn.addEventListener('click', () => {
      groupFilterSelect.value = "All";
      searchSkillInput.value = "";
      colorBySelect.value = "Group";
      updatePlot();
    });
    
    // ---------------------
    // 10. On Page Load: Render the Plot
    // ---------------------
    document.addEventListener('DOMContentLoaded', () => {
      updatePlot();
    });
    
    // View preset configurations
    const viewPresets = {
      default: {
        eye: { x: 1.8, y: 1.8, z: 1.8 },
        center: { x: 0, y: 0, z: 0 }
      },
      top: {
        eye: { x: 0, y: 0, z: 2.5 },
        center: { x: 0, y: 0, z: 0 }
      },
      side: {
        eye: { x: 2.5, y: 0, z: 0 },
        center: { x: 0, y: 0, z: 0 }
      },
      cluster: {
        eye: { x: 2, y: 2, z: 2 },
        center: { x: 0.5, y: 0.5, z: 0.5 }
      }
    };
    
    // Handle view preset changes
    viewPresetsSelect.addEventListener('change', (e) => {
      const preset = viewPresets[e.target.value];
      if (preset) {
        Plotly.relayout('plot', {
          'scene.camera.eye': preset.eye,
          'scene.camera.center': preset.center
        });
      }
    });
    
    // Handle animation speed changes
    animationSpeedInput.addEventListener('input', (e) => {
      const duration = parseInt(e.target.value);
      // Store for use in updatePlot
      window.animationDuration = duration;
    });
    
    // Handle label size changes
    labelSizeInput.addEventListener('input', (e) => {
      const size = parseInt(e.target.value);
      const update = {
        'textfont.size': size
      };
      Plotly.restyle('plot', update);
    });
    
    // Add additional CSS for range sliders
    const style = document.createElement('style');
    style.textContent = `
      .control-group input[type="range"] {
        width: 100%;
        margin: 8px 0;
      }
      
      .control-panel select,
      .control-panel input[type="range"] {
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 4px;
      }
      
      .control-panel input[type="range"]::-webkit-slider-thumb {
        background: #0066cc;
        border: none;
        height: 16px;
        width: 16px;
        border-radius: 50%;
        cursor: pointer;
        margin-top: -6px;
      }
      
      .control-panel input[type="range"]::-moz-range-thumb {
        background: #0066cc;
        border: none;
        height: 16px;
        width: 16px;
        border-radius: 50%;
        cursor: pointer;
      }
    `;
    document.head.appendChild(style);

    // Skill Relationship Management
    class SkillRelationshipManager {
      constructor(skills) {
        this.skills = skills;
        this.relationships = this.computeRelationships();
      }

      computeRelationships() {
        const relationships = new Map();
        
        this.skills.forEach(skill => {
          relationships.set(skill.Skill, {
            related: this.findRelatedSkills(skill),
            dependencies: this.findDependencies(skill),
            synergies: this.findSynergies(skill)
          });
        });
        
        return relationships;
      }

      findRelatedSkills(skill) {
        return this.skills
          .filter(s => 
            s.Group === skill.Group && 
            s.Skill !== skill.Skill &&
            Math.abs(s.X - skill.X) < 0.2 &&
            Math.abs(s.Y - skill.Y) < 0.2
          )
          .map(s => s.Skill);
      }

      findDependencies(skill) {
        return this.skills
          .filter(s => 
            s.X < skill.X &&
            Math.abs(s.Y - skill.Y) < 0.3
          )
          .map(s => s.Skill);
      }

      findSynergies(skill) {
        return this.skills
          .filter(s =>
            s.Group !== skill.Group &&
            Math.abs(s.Size - skill.Size) < 2 &&
            Math.abs(s.X - skill.X) < 0.15
          )
          .map(s => s.Skill);
      }
    }

    // Skill Details Panel Manager
    class SkillDetailsPanelManager {
      constructor(panel, relationshipManager) {
        this.panel = panel;
        this.relationshipManager = relationshipManager;
        this.setupEventListeners();
      }

      setupEventListeners() {
        this.panel.querySelector('.close-btn').addEventListener('click', () => {
          this.hidePanel();
        });
      }

      showPanel(skill) {
        const relationships = this.relationshipManager.relationships.get(skill.Skill);
        this.updatePanelContent(skill, relationships);
        this.panel.classList.add('active');
      }

      hidePanel() {
        this.panel.classList.remove('active');
      }

      updatePanelContent(skill, relationships) {
        const metricsDiv = this.panel.querySelector('.skill-metrics');
        const relatedDiv = this.panel.querySelector('.related-skills');
        const progressionDiv = this.panel.querySelector('.skill-progression');

        // Update metrics
        metricsDiv.innerHTML = `
          <div class="metric-card">
            <div class="metric-value">${(skill.X * 100).toFixed(0)}%</div>
            <div class="metric-label">Proficiency</div>
          </div>
          <div class="metric-card">
            <div class="metric-value">${(skill.Y * 100).toFixed(0)}%</div>
            <div class="metric-label">Importance</div>
          </div>
          <div class="metric-card">
            <div class="metric-value">${skill.Size}</div>
            <div class="metric-label">Impact</div>
          </div>
          <div class="metric-card">
            <div class="metric-value">${relationships.synergies.length}</div>
            <div class="metric-label">Synergies</div>
          </div>
        `;

        // Update related skills
        relatedDiv.innerHTML = `
          <h4>Related Skills</h4>
          <div class="skill-tags">
            ${relationships.related.map(skill => 
              `<span class="skill-tag">${skill}</span>`
            ).join('')}
          </div>
        `;

        // Update progression
        progressionDiv.innerHTML = `
          <h4>Skill Progress</h4>
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${skill.X * 100}%"></div>
          </div>
        `;
      }
    }

    // Connection Renderer
    class SkillConnectionRenderer {
      constructor(canvas, skills, relationshipManager) {
        this.canvas = canvas;
        this.ctx = canvas.getContext('2d');
        this.skills = skills;
        this.relationshipManager = relationshipManager;
        this.setupCanvas();
      }

      setupCanvas() {
        this.resizeCanvas();
        window.addEventListener('resize', () => this.resizeCanvas());
      }

      resizeCanvas() {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
      }

      drawConnections(activeSkill) {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        
        if (!activeSkill) return;

        const relationships = this.relationshipManager.relationships.get(activeSkill.Skill);
        
        // Draw different types of connections
        this.drawRelationshipLines(activeSkill, relationships.related, 'rgba(75, 192, 192, 0.4)', 2);
        this.drawRelationshipLines(activeSkill, relationships.dependencies, 'rgba(255, 99, 132, 0.4)', 2);
        this.drawRelationshipLines(activeSkill, relationships.synergies, 'rgba(153, 102, 255, 0.4)', 2);
      }

      drawRelationshipLines(sourceSkill, relatedSkills, color, width) {
        this.ctx.beginPath();
        this.ctx.strokeStyle = color;
        this.ctx.lineWidth = width;

        relatedSkills.forEach(skillName => {
          const targetSkill = this.skills.find(s => s.Skill === skillName);
          if (targetSkill) {
            // Convert 3D coordinates to 2D screen coordinates
            // This would need to be coordinated with Plotly's current view
            // You'll need to implement this conversion based on your specific needs
            this.ctx.moveTo(sourceSkill.screenX, sourceSkill.screenY);
            this.ctx.lineTo(targetSkill.screenX, targetSkill.screenY);
          }
        });

        this.ctx.stroke();
      }
    }

    // Initialize new features
    const relationshipManager = new SkillRelationshipManager(allSkills);
    const detailsPanel = new SkillDetailsPanelManager(
      document.querySelector('.skill-details-panel'),
      relationshipManager
    );
    const connectionRenderer = new SkillConnectionRenderer(
      document.getElementById('connectionCanvas'),
      allSkills,
      relationshipManager
    );

    // Modify the existing plot click handler
    plot.on('plotly_click', (data) => {
      const point = data.points[0];
      const skill = allSkills.find(s => 
        s.X === point.x && 
        s.Y === point.y && 
        s.Group === point.data.name
      );
      
      if (skill) {
        detailsPanel.showPanel(skill);
        connectionRenderer.drawConnections(skill);
      }
    });

    // Theme Management
    class ThemeManager {
      constructor() {
        this.themeToggle = document.getElementById('themeToggle');
        this.currentTheme = localStorage.getItem('theme') || 'light';
        this.init();
      }

      init() {
        document.documentElement.setAttribute('data-theme', this.currentTheme);
        this.themeToggle.addEventListener('click', () => this.toggleTheme());
        this.updatePlotColors();
      }

      toggleTheme() {
        this.currentTheme = this.currentTheme === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', this.currentTheme);
        localStorage.setItem('theme', this.currentTheme);
        this.updatePlotColors();
      }

      updatePlotColors() {
        const isDark = this.currentTheme === 'dark';
        const newLayout = {
          ...layout,
          paper_bgcolor: isDark ? '#1a1a1a' : '#f7f7f7',
          plot_bgcolor: isDark ? '#1a1a1a' : '#f7f7f7',
          font: {
            color: isDark ? '#e0e0e0' : '#333'
          },
          scene: {
            ...layout.scene,
            xaxis: {
              ...layout.scene.xaxis,
              gridcolor: isDark ? '#404040' : '#e0e0e0',
              zerolinecolor: isDark ? '#606060' : '#999',
              backgroundcolor: isDark ? 'rgba(26, 26, 26, 0.95)' : 'rgba(247, 247, 247, 0.95)'
            },
            yaxis: {
              ...layout.scene.yaxis,
              gridcolor: isDark ? '#404040' : '#e0e0e0',
              zerolinecolor: isDark ? '#606060' : '#999',
              backgroundcolor: isDark ? 'rgba(26, 26, 26, 0.95)' : 'rgba(247, 247, 247, 0.95)'
            },
            zaxis: {
              ...layout.scene.zaxis,
              gridcolor: isDark ? '#404040' : '#e0e0e0',
              zerolinecolor: isDark ? '#606060' : '#999',
              backgroundcolor: isDark ? 'rgba(26, 26, 26, 0.95)' : 'rgba(247, 247, 247, 0.95)'
            }
          }
        };

        Plotly.relayout('plot', newLayout);
      }
    }

    // Initialize theme manager
    const themeManager = new ThemeManager();

    // Add to the script section
    class VisualizationManager {
      constructor(container, skills) {
        this.container = container;
        this.skills = skills;
        this.currentMode = 'galaxy';
        this.setupEventListeners();
      }

      setupEventListeners() {
        document.getElementById('visualizationMode').addEventListener('change', (e) => {
          this.switchVisualizationMode(e.target.value);
        });
      }

      switchVisualizationMode(mode) {
        this.currentMode = mode;
        this.clearContainer();
        
        switch (mode) {
          case 'galaxy':
            this.render3DGalaxy();
            break;
          case 'network':
            this.renderNetworkGraph();
            break;
          case 'treemap':
            this.renderTreeMap();
            break;
          case 'radar':
            this.renderRadarChart();
            break;
          case 'sunburst':
            this.renderSunburstChart();
            break;
          case 'timeline':
            this.renderTimeline();
            break;
          case 'matrix':
            this.renderCorrelationMatrix();
            break;
        }
      }

      clearContainer() {
        while (this.container.firstChild) {
          this.container.removeChild(this.container.firstChild);
        }
      }

      render3DGalaxy() {
        // Existing 3D galaxy visualization
        updatePlot();
      }

      renderNetworkGraph() {
        const trace = {
          type: 'scatter',
          mode: 'markers+text',
          x: this.skills.map(s => s.X),
          y: this.skills.map(s => s.Y),
          text: this.skills.map(s => s.Label),
          textposition: 'top center',
          marker: {
            size: this.skills.map(s => s.Size * 3),
            color: this.skills.map(s => colorByGroup(s.Group))
          },
          hoverinfo: 'text'
        };

        const layout = {
          title: 'Skill Network',
          showlegend: false,
          hovermode: 'closest',
          xaxis: { showgrid: false, zeroline: false, showticklabels: false },
          yaxis: { showgrid: false, zeroline: false, showticklabels: false }
        };

        Plotly.newPlot(this.container, [trace], layout);
      }

      renderTreeMap() {
        const data = [{
          type: 'treemap',
          labels: this.skills.map(s => s.Label),
          parents: this.skills.map(s => s.Group),
          values: this.skills.map(s => s.Size),
          textinfo: 'label+value',
          marker: {
            colors: this.skills.map(s => colorByGroup(s.Group))
          }
        }];

        const layout = {
          title: 'Skill Distribution TreeMap'
        };

        Plotly.newPlot(this.container, data, layout);
      }

      renderRadarChart() {
        const groups = [...new Set(this.skills.map(s => s.Group))];
        const data = groups.map(group => {
          const groupSkills = this.skills.filter(s => s.Group === group);
          return {
            type: 'scatterpolar',
            name: group,
            r: groupSkills.map(s => s.Size),
            theta: groupSkills.map(s => s.Label),
            fill: 'toself',
            line: {
              color: colorByGroup(group)
            }
          };
        });

        const layout = {
          title: 'Skill Radar Chart',
          polar: {
            radialaxis: {
              visible: true,
              range: [0, 15]
            }
          },
          showlegend: true
        };

        Plotly.newPlot(this.container, data, layout);
      }

      renderSunburstChart() {
        const data = [{
          type: 'sunburst',
          labels: this.skills.map(s => s.Label),
          parents: this.skills.map(s => s.Group),
          values: this.skills.map(s => s.Size),
          outsidetextfont: { size: 20, color: '#377eb8' },
          leaf: { opacity: 0.4 },
          marker: { line: { width: 2 } }
        }];

        const layout = {
          title: 'Skill Hierarchy Sunburst',
          width: 1000,
          height: 1000
        };

        Plotly.newPlot(this.container, data, layout);
      }

      renderTimeline() {
        const trace = {
          type: 'scatter',
          mode: 'markers+lines+text',
          x: this.skills.map((_, i) => i),
          y: this.skills.map(s => s.Size),
          text: this.skills.map(s => s.Label),
          textposition: 'top center',
          marker: {
            size: 10,
            color: this.skills.map(s => colorByGroup(s.Group))
          },
          line: { shape: 'spline' }
        };

        const layout = {
          title: 'Skill Development Timeline',
          xaxis: { title: 'Progression' },
          yaxis: { title: 'Skill Level' }
        };

        Plotly.newPlot(this.container, [trace], layout);
      }

      renderCorrelationMatrix() {
        const groups = [...new Set(this.skills.map(s => s.Group))];
        const correlationData = groups.map(g1 => 
          groups.map(g2 => {
            const skills1 = this.skills.filter(s => s.Group === g1);
            const skills2 = this.skills.filter(s => s.Group === g2);
            return this.calculateGroupCorrelation(skills1, skills2);
          })
        );

        const data = [{
          type: 'heatmap',
          z: correlationData,
          x: groups,
          y: groups,
          colorscale: 'Viridis'
        }];

        const layout = {
          title: 'Skill Group Correlation Matrix',
          xaxis: { side: 'bottom' },
          yaxis: { autorange: 'reversed' }
        };

        Plotly.newPlot(this.container, data, layout);
      }

      calculateGroupCorrelation(skills1, skills2) {
        const sizes1 = skills1.map(s => s.Size);
        const sizes2 = skills2.map(s => s.Size);
        const mean1 = sizes1.reduce((a, b) => a + b, 0) / sizes1.length;
        const mean2 = sizes2.reduce((a, b) => a + b, 0) / sizes2.length;
        
        const correlation = sizes1.reduce((acc, size1, i) => 
          acc + (size1 - mean1) * (sizes2[i % sizes2.length] - mean2), 0
        ) / Math.sqrt(
          sizes1.reduce((acc, size) => acc + Math.pow(size - mean1, 2), 0) *
          sizes2.reduce((acc, size) => acc + Math.pow(size - mean2, 2), 0)
        );

        return correlation;
      }
    }

    // Initialize visualization manager after DOM content is loaded
    document.addEventListener('DOMContentLoaded', () => {
      const visualizationManager = new VisualizationManager(
        document.getElementById('plot'),
        allSkills
      );
    });
  </script>
</body>
</html>
